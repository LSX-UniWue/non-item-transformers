Project Code Overview
=====================

After installing the virtual environment as described in the :ref:`Project Overview <project_overview>` setup your IDE to use the virtual
environment generated by Poetry. It is commonly found under ``recommender/venv/recommender``.

The project is structured into 14 folders:

- `configs <../configs>`__: Contains yaml files which are needed to configure the uses of models in conjunction with metrics and data sets
- `docs <./../docs>`__: Contains rst files which contain the documentation for this project
- `k8s <./../k8s>`__: Contains a dockerfile which defines a docker container which runs a model when started, an example for a kubernetes job and pod configuration for said dockerfile
- `src <./../src>`__: Contains the source code
    - `asme <./../src/asme>`__: ??
        - `callbacks <./../src/asme/callbacks>`__: Contains code for tracking the best model
        - `init <./../src/asme/init>`__: Contains code regarding the model initialization
        - `losses <./../src/asme/losses>`__: Contains code regarding custom loss functions which can be integrated into pytorch training
        - `metrics <./../src/asme/metrics>`__: Contains code regarding the implementation of recommendation metrics which are integrated using pytorch
        - `models <./../src/asme/models>`__: Contains pytorch implementations of the models provided by this framework
        - `modules <./../src/asme/modules>`__: Contains pytorch-lightning wrappers for the pytorch models defined in `models <./../src/asme/models>`__
        - `tokenization <./../src/asme/tokenization>`__: Contains code concerning the tokenization of session items and the building of a vocabulary for data sets
        - `utils <./../src/asme/utils>`__
        - `writer <./../src/asme/writer>`__: Contains the writer interfaces for prediction and results
    - `data <./../src/data>`__: Contains code regarding the indexing of data sets and reading of stored indices
    - `dataset <./../src/datasets>`__: Contains code regarding the integration of data sets into the framework
- `tests <./../tests>`__: Contains unit tests for the project. Also contains an example data set as well as the respective vocabulary and index file

Adding a new Metric
-------------------

The metric needs to be able to handle tensors to be compatible with pytorch.

To implement it go to `metrics/ranking\_metrics <../asme/metrics/ranking_metrics.py>`__ and
implement a new metrics class.

Adding a new Data set
---------------------

All necessary files for the integration of data sets can be found under
the `dataset folder <../datasets>`__.

In order to add a new dataset and make it usable you have to implement
the following steps:

1. Download the data set or document where it is available
2. Index the data set and create train, validation, test split
3. Create a vocabulary for the data set
4. Integrate those steps into the dataset `Typer <https://typer.tiangolo.com/>`__ CLI as a new command under `dataset/app/data\_set\_commands.py <../datasets/app/data_set_commands.py>`__

Adding a new Model
------------------

In order to add a new model multiple things need to be implemented:

1. The model itself as a pytorch model in `models <./../src/asme/models>`__
2. If necessary, the corresponding loss in `asme/losses/ <./../src/asme/losses>`__
2. A `asme/init/factories/container <./../src/asme/init/factories/container.py>`__, including the respective module and loss.

2. A pytorch lightning module that wraps the torch implementation of your newly implemented model in `modules <../asme/modules>`__
3. A configuration container in `runner/util/containers <../asme/runner/util/containers.py>`__ and the respective connection in `runner/run\_model <../asme/runner/run_model.py>`__

Things that are not documented
------------------------------

This section lists areas of the project that are not documented/need
code comments:

- Contents of the "support-code" in `runner/util <../asme/runner/util>`__
- Most methods, classes, and modules

Refactor proposals
------------------

-  The prediction logger callback for pytorch lightning is contained in
   `runner/util <../asme/runner/util>`__ (I [AL] would expect this to be
   at `logger <./../logger>`__)
-  The code in `runner/util <../asme/runner/util>`__ is quite extensive
   and should probably be moved into multiple separate directories (e.g.
   `runner/util/containers <../asme/runner/util/containers.py>`__ could
   be a directory)
-  Every directory deserves its own little README.md describing its
   purpose, contents, and implementation hints in a few sentences
-  If this project aims to become a CLI one day the project structure
   should represent that by:

   -  Either: directories should be structured into commands
   -  Or: An app directory should be created in which commands are
      defined and registered at one central file

-  If a class is defined in a file the file should have the same name as
   the class (e.g., `indexer.py <./../data/base/indexer.py>`__ defines
   the CsvSessionIndexer class)
-  If a file defines multiple classes make it a directory.

